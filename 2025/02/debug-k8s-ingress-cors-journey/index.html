<!doctype html><html lang=en-us x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Kubernetes Hands-on: Debugging a CORS Error Journey | AI Solve</title>
<link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://jiejue.ai/2025/02/debug-k8s-ingress-cors-journey/><meta name=author content="Dong Hao"><meta name=description content="As a developer, have you ever encountered a situation where your service suddenly stops working, even though you haven&rsquo;t changed any code and all configurations seem correct? Today, I want to share a real-world case of debugging a CORS issue in a Kubernetes environment, hoping it might provide some insights for those facing similar challenges.
"><meta name=keywords content><meta name=generator content="Hugo 0.144.2"><meta property="og:url" content="https://jiejue.ai/2025/02/debug-k8s-ingress-cors-journey/"><meta property="og:site_name" content="AI Solve"><meta property="og:title" content="Kubernetes Hands-on: Debugging a CORS Error Journey"><meta property="og:description" content="As a developer, have you ever encountered a situation where your service suddenly stops working, even though you haven’t changed any code and all configurations seem correct? Today, I want to share a real-world case of debugging a CORS issue in a Kubernetes environment, hoping it might provide some insights for those facing similar challenges."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-14T17:05:31+04:00"><meta property="article:modified_time" content="2025-02-21T10:56:16+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes Hands-on: Debugging a CORS Error Journey"><meta name=twitter:description content="As a developer, have you ever encountered a situation where your service suddenly stops working, even though you haven’t changed any code and all configurations seem correct? Today, I want to share a real-world case of debugging a CORS issue in a Kubernetes environment, hoping it might provide some insights for those facing similar challenges."><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:online" @click="flip = !flip" title="Flip it!"><div class="h-10 rounded-full"><img src=/favicon.ico alt="AI Solve"></div></div><div><a href=https://jiejue.ai/ class="text-lg font-semibold cursor-pointer">AI Solve</a><div class="text-base-content/60 text-sm">Using AI to Serve People</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/posts title=Archives><ion-icon class=group-hover:text-primary-content name=archive></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/tags title="All Tags"><ion-icon class=group-hover:text-primary-content name=pricetags></ion-icon></a></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="Kubernetes Hands-on: Debugging a CORS Error Journey"><meta itemprop=description content="As a developer, have you ever encountered a situation where your service suddenly stops working, even though you haven’t changed any code and all configurations seem correct? Today, I want to share a real-world case of debugging a CORS issue in a Kubernetes environment, hoping it might provide some insights for those facing similar challenges."><meta itemprop=datePublished content="2025-02-14T17:05:31+04:00"><meta itemprop=dateModified content="2025-02-21T10:56:16+05:30"><meta itemprop=wordCount content="811"><header><h1 itemprop=headline>Kubernetes Hands-on: Debugging a CORS Error Journey</h1><p class=text-sm><span data-format=luxon>2025-02-14T17:05:31+04:00</span>
| <span>4 minute read</span>
| <span>Updated at
<span data-format=luxon>2025-02-21T10:56:16+05:30</span></span></p><div class="flex justify-between"><div class="flex items-center"><span>@</span>
<span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>Dong Hao</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=Kubernetes%20Hands-on:%20Debugging%20a%20CORS%20Error%20Journey&amp;url=https://jiejue.ai/2025/02/debug-k8s-ingress-cors-journey/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://jiejue.ai/2025/02/debug-k8s-ingress-cors-journey/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=Kubernetes%20Hands-on:%20Debugging%20a%20CORS%20Error%20Journey%20https://jiejue.ai/2025/02/debug-k8s-ingress-cors-journey/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img src=https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250214170724294.webp alt="Kubernetes Hands-on: Debugging a CORS Error Journey"><p>As a developer, have you ever encountered a situation where your service suddenly stops working, even though you haven&rsquo;t changed any code and all configurations seem correct? Today, I want to share a real-world case of debugging a CORS issue in a Kubernetes environment, hoping it might provide some insights for those facing similar challenges.</p><h2 id=background>Background</h2><p>Our web application is deployed on Azure Kubernetes Service (AKS), and the original architecture looked like this:</p><pre tabindex=0><code>User Request -&gt; Application Gateway -&gt; Service -&gt; Pod
</code></pre><p>To optimize performance, we needed to add a Nginx Ingress layer in between. The architecture changed as follows:</p><pre class=mermaid>graph TB
    User((User))
    AppGW[Application Gateway]
    Ingress[Nginx Ingress]
    Svc[Service]
    Pod[Pod]

    subgraph Original Architecture
        User -->|1.Request| AppGW
        AppGW -->|2.Forward| Svc
        Svc -->|3.Route| Pod
    end

    subgraph New Architecture
        User -->|1.Request| AppGW
        AppGW -->|2.Forward| Ingress
        Ingress -->|3.Route| Svc
        Svc -->|4.Forward| Pod
    end

    style User fill:#f9f,stroke:#333,stroke-width:2px
    style AppGW fill:#bbf,stroke:#333,stroke-width:2px
    style Ingress fill:#bfb,stroke:#333,stroke-width:2px
    style Svc fill:#fbb,stroke:#333,stroke-width:2px
    style Pod fill:#bff,stroke:#333,stroke-width:2px</pre><p>After configuration, we discovered CORS (Cross-Origin Resource Sharing) errors in the browser. While this issue seemed simple at first, the troubleshooting process turned out to be quite interesting.</p><h2 id=first-attempt-adding-cors-configuration>First Attempt: Adding CORS Configuration</h2><p>As the &ldquo;standard approach&rdquo; to handling CORS issues, we first tried adding CORS-related settings in the Ingress configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/enable-cors</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/cors-allow-origin</span>: <span style=color:#e6db74>&#34;https://our-frontend-domain&#34;</span>
</span></span></code></pre></div><p>Result: Failed. The browser still reported CORS errors.</p><h2 id=deep-investigation-systematic-thinking>Deep Investigation: Systematic Thinking</h2><p>At this point, we began to analyze the problem systematically:</p><ol><li>Check the OPTIONS request (preflight request) response:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X OPTIONS -I <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Origin: https://our-frontend-domain&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Access-Control-Request-Method: POST&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  https://our-backend-domain
</span></span></code></pre></div><p>The response looked correct, including all necessary CORS headers.</p><ol start=2><li>Check Nginx Ingress logs:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n ingress-namespace logs -l app<span style=color:#f92672>=</span>nginx-internal-0 -f
</span></span></code></pre></div><p>We found a crucial piece of information in the logs: requests were being forwarded to an unexpected service <code>[app2-app2-service-80]</code> instead of our expected <code>app1-service</code>.</p><h2 id=the-truth-unexpected-configuration-conflict>The Truth: Unexpected Configuration Conflict</h2><p>Through log analysis, we discovered a forgotten Ingress configuration that was affecting our service. It&rsquo;s like having your WiFi signal interfered with by your neighbor&rsquo;s router — two configurations were &ldquo;fighting&rdquo; in the same environment.</p><p>In Azure AKS, all Ingress shares the same IP address, meaning that Ingress configurations from different projects can interfere with each other. We found that an unused <code>app2-ingress</code> configuration still existed and was interfering with our request routing.</p><h2 id=solution-simplifying-complexity>Solution: Simplifying Complexity</h2><p>The final solution included three key steps:</p><ol><li>Fix the Ingress path configuration:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/(.*)</span> <span style=color:#75715e># Use wildcard to match all paths</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pathType</span>: <span style=color:#ae81ff>Prefix</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app1-service</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nginx.ingress.kubernetes.io/rewrite-target</span>: <span style=color:#ae81ff>/$1</span> <span style=color:#75715e># Ensure correct path forwarding</span>
</span></span></code></pre></div><ol start=2><li>Delete unused Ingress configurations:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete ingress app2-ingress -n app2 
</span></span></code></pre></div><ol start=3><li>Remove all manually added CORS configurations (let the backend service handle CORS)</li></ol><p>A special note about the first step&rsquo;s path configuration:</p><ul><li><code>path: /(.*)</code> matches all request paths</li><li><code>rewrite-target: /$1</code> ensures requests are correctly forwarded to the backend service, maintaining the original path</li><li>Without this configuration, all requests might be forwarded to the root path <code>/</code>, causing APP1 to malfunction</li></ul><p>Problem solved!</p><h2 id=lessons-learned>Lessons Learned</h2><p>We can summarize this debugging process with the following mind map:</p><pre class=mermaid>mindmap
  root((CORS Issue))
    Configuration Check
      Path Configuration
        Check path rules
        Add rewrite-target
      CORS Configuration
        Try adding CORS annotations
        Discover interference
    Log Analysis
      Check OPTIONS requests
        Response status code
        CORS response headers
      Observe Nginx logs
        Upstream service name
        Request forwarding path
    Environment Investigation
      Find redundant configs
        Legacy app2-ingress
        Shared IP address impact
      Clean environment
        Delete unused ingress
        Simplify CORS config
    Final Solution
      Correct path config
        Use /(.*)
        Add rewrite-target
      Remove CORS annotations
        Let backend handle CORS
        Keep config simple
      Clean redundant configs
        Delete app2-ingress
        Avoid rule conflicts</pre><p>This debugging experience taught us several important lessons:</p><ol><li><p><strong>Logs are Important</strong></p><ul><li>Every detail in logs could be a clue</li><li>Pay special attention to which service requests are forwarded to (upstream information)</li></ul></li><li><p><strong>Understand Environment Characteristics</strong></p><ul><li>In AKS, the same Ingress Controller shares one IP</li><li>This means Ingress configurations from different projects can affect each other</li><li>Be particularly careful to clean up unused configurations</li></ul></li><li><p><strong>Simpler Configuration is Better</strong></p><ul><li>Sometimes &ldquo;extra protection&rdquo; can complicate things</li><li>If the backend service already handles CORS correctly, don&rsquo;t configure it again at the Ingress layer</li></ul></li><li><p><strong>Think Systematically</strong></p><ul><li>The problem might not be where you first suspect</li><li>Check each component methodically, looking for anomalies</li></ul></li></ol><h2 id=practical-advice>Practical Advice</h2><p>If you encounter similar issues in a Kubernetes environment, follow this troubleshooting process:</p><ol><li>Check logs, particularly focusing on request forwarding paths</li><li>Examine all related configurations, including seemingly unrelated old ones</li><li>Start with simple solutions</li><li>Keep the environment clean, promptly remove unused configurations</li></ol><p>Finally, I want to say: in microservice architectures, problems are often not as simple as they appear. But with patience and systematic analysis, we can always find a solution. While debugging can be frustrating at times, each successful investigation deepens our understanding of the system.</p><p>I hope this article helps you when facing similar issues. If you have similar experiences or other thoughts, feel free to share in the comments!</p></section><div class=divider></div><div class="flex flex-col md:flex-row justify-between gap-4 py-4"><a class="group btn btn-outline" href=/2025/02/git-rescue-wrong-commit/ title="Git Rescue: How to Separate a File from Your Recent Commit"><ion-icon name=chevron-back></ion-icon><div class="inline-flex flex-col items-start"><span class="text-base-content/60 group-hover:text-neutral-content/60 text-xs font-normal">Previous page</span>
<span class="max-w-48 truncate">Git Rescue: How to Separate a File from Your Recent Commit</span></div></a><a class="group btn btn-outline" href=/2025/02/future-car-as-platform/ title="The New Era of Automobiles: Evolution from Transportation to Living Platform"><div class="inline-flex flex-col items-end"><span class="text-base-content/60 group-hover:text-neutral-content/60 text-xs font-normal">Next page</span>
<span class="max-w-48 truncate">The New Era of Automobiles: Evolution from Transportation to Living Platform</span></div><ion-icon name=chevron-forward></ion-icon></a></div></article></div><div class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#first-attempt-adding-cors-configuration>First Attempt: Adding CORS Configuration</a></li><li><a href=#deep-investigation-systematic-thinking>Deep Investigation: Systematic Thinking</a></li><li><a href=#the-truth-unexpected-configuration-conflict>The Truth: Unexpected Configuration Conflict</a></li><li><a href=#solution-simplifying-complexity>Solution: Simplifying Complexity</a></li><li><a href=#lessons-learned>Lessons Learned</a></li><li><a href=#practical-advice>Practical Advice</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 AI Solve</p><p>Silicon-based Life Kindergarten</p></div><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
Site Total Visits <span id=busuanzi_value_site_pv></span>
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user"></i>
Site Visitor Count <span id=busuanzi_value_site_uv></span></span></section></span></section></script><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 AI Solve</p><p>Silicon-based Life Kindergarten</p></div><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
Site Total Visits <span id=busuanzi_value_site_pv></span>
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user"></i>
Site Visitor Count <span id=busuanzi_value_site_uv></span></span></section></span></section></script><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"en"}).toFormat("yyyy-MM-dd HH:mm")})}</script><script type=module>
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img')
    </script><script type=module>
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
      </script><script async src="https://www.googletagmanager.com/gtag/js?id=G-S0KCH9BW4F"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-S0KCH9BW4F")}</script><script type=module src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js></script><script nomodule src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js></script></body></html>